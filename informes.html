<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Informes | FerreStock Bellon</title>

<!-- Librería para generar Excel profesional -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>

<style>
:root{
    --oscuro:#1f1f1f;
    --medio:#2b2b2b;
    --naranja:#df7d06;
    --texto:#ffffff;
    --rojo:#c0392b;
    --azul:#2980b9;
    --verde:#27ae60;
}

*{
    box-sizing:border-box;
    font-family:Segoe UI, Arial, sans-serif;
    color:var(--texto);
}

body{
    margin:0;
    background:var(--oscuro);
    padding-top:90px;
}

/* HEADER */
header{
    position:fixed;
    top:0;
    width:100%;
    background:#1b1b1b;
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:15px 50px;
    border-bottom:3px solid var(--naranja);
    z-index:100;
}

header h1{
    margin:0;
    color:var(--naranja);
}

nav{
    display:flex;
    align-items:center;
}

nav a, nav span{
    margin-left:25px;
    text-decoration:none;
    font-weight:600;
    cursor:pointer;
    color: #fff;
}

nav a:hover{
    color:var(--naranja);
}

/* Estilo para enlace activo en el menú */
nav a.activo{
    color:var(--naranja);
    font-weight:700;
    border-bottom:3px solid var(--naranja);
    padding-bottom:5px;
}

#bienvenida{
    color:var(--naranja);
}

#inventarioLink, #stockLink, #productosLink, #informesLink{
    display:none;
}

/* CONTENIDO */
.container{
    padding:40px;
}

h1{
    color:var(--naranja);
}

h2{
    color:var(--naranja);
    margin-top:30px;
    border-bottom:2px solid var(--naranja);
    padding-bottom:10px;
}

.controles{
    display:flex;
    gap:15px;
    margin-bottom:25px;
    flex-wrap:wrap;
}

button{
    padding:10px 15px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-weight:600;
    color: white;
    background:var(--naranja);
}

button:hover{
    background:#f59b1a;
}

button.btn-descargar{
    background:var(--azul);
}

button.btn-descargar:hover{
    background:#3498db;
}

table{
    width:100%;
    border-collapse:collapse;
    margin-bottom:30px;
    background:var(--medio);
    border-radius:10px;
    overflow:hidden;
}

th, td{
    padding:14px;
    text-align:left;
}

th{
    background:#191919;
    color:var(--naranja);
    font-weight:600;
}

tr:nth-child(even){
    background:#252525;
}

tr:hover{
    background:#2a2a2a;
}

.stats{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));
    gap:20px;
    margin-bottom:30px;
}

.stat-box{
    background:var(--medio);
    padding:20px;
    border-radius:10px;
    border-left:4px solid var(--naranja);
}

.stat-box h3{
    margin:0 0 10px 0;
    color:#ccc;
    font-size:14px;
    text-transform:uppercase;
}

.stat-box .numero{
    font-size:28px;
    color:var(--naranja);
    font-weight:700;
}

.stat-box.warning{
    border-left-color:var(--rojo);
}

.stat-box.warning .numero{
    color:var(--rojo);
}

.resumen{
    background:var(--medio);
    padding:20px;
    border-radius:10px;
    margin-bottom:30px;
    border-left:4px solid var(--naranja);
}

.resumen p{
    margin:8px 0;
    line-height:1.6;
}

.sin-datos{
    text-align:center;
    padding:40px;
    color:#999;
}

@media(max-width:768px){
    header{
        padding:10px 20px;
    }
    
    nav a, nav span{
        margin-left:10px;
        font-size:12px;
    }
    
    .container{
        padding:20px;
    }
    
    .controles{
        flex-direction:column;
    }
    
    button{
        width:100%;
    }
}
</style>
</head>

<body>

<script>
// Protección: solo admin puede acceder
const role = localStorage.getItem('rol');
if(role !== 'admin'){
    alert('Acceso denegado. Solo administradores pueden acceder aquí.');
    window.location.href = 'base.html';
}
</script>

<header>
    <h1 onclick="window.location.href='base.html'" style="cursor:pointer;">FerreStock Bellon</h1>
    <nav>
        <span id="bienvenida"></span>
        <a onclick="window.location.href='base.html'">Inicio</a>
        <a id="productosLink" href="productos.html">Productos</a>
        <a id="stockLink" href="stock.html">Stock</a>
        <a id="inventarioLink" href="inventario.html">Inventario</a>
        <a id="informesLink" href="informes.html">Informes</a>
        <a id="contactoLink" href="Contacto.html">Contacto</a>
        <a id="loginLink" href="login.html">Iniciar sesión</a>
        <a id="logoutLink" onclick="cerrarSesion()">Cerrar sesión</a>
    </nav>
</header>

<div class="container">
    <h1> Informes de FerreStock</h1>
    <p style="color:#ccc;">Análisis del inventario y stock general</p>

    <div class="controles">

        <button class="btn-descargar" onclick="descargarInformeExcel()"> Descargar Excel</button>
        <button onclick="imprimirInforme()"> Imprimir</button>
    </div>

    <!-- ESTADÍSTICAS GENERALES -->
    <h2>Estadísticas Generales</h2>
    <div class="stats">
        <div class="stat-box">
            <h3>Productos en Stock</h3>
            <div class="numero" id="totalProductos">0</div>
        </div>
        <div class="stat-box">
            <h3>Cantidad Total de Unidades</h3>
            <div class="numero" id="totalUnidades">0</div>
        </div>
        <div class="stat-box">
            <h3>Productos Ubicados</h3>
            <div class="numero" id="productosUbicados">0</div>
        </div>
        <div class="stat-box warning">
            <h3>Sin Ubicación</h3>
            <div class="numero" id="sinUbicacion">0</div>
        </div>
    </div>

    <!-- INFORME DE STOCK -->
    <h2>Informe de Stock</h2>
    <table id="tablaStock">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Categoría</th>
                <th>Cantidad</th>
                <th>Ubicación</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody id="cuerpoTablaStock">
            <tr><td colspan="5" class="sin-datos">Cargando datos...</td></tr>
        </tbody>
    </table>

    <!-- RESUMEN DE INVENTARIO -->
    <h2>Resumen de Inventario</h2>
    <div class="resumen" id="resumenInventario">
        <p style="color:#999;">Cargando resumen...</p>
    </div>

    <!-- PRODUCTOS SIN UBICACIÓN -->
    <h2>⚠️ Productos Sin Ubicación Asignada</h2>
    <table id="tablaSinUbicacion">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Categoría</th>
                <th>Cantidad</th>
                <th>Acción</th>
            </tr>
        </thead>
        <tbody id="cuerpoTablaSinUbicacion">
            <tr><td colspan="4" class="sin-datos">Todos los productos tienen ubicación</td></tr>
        </tbody>
    </table>

    <!-- PRODUCTOS CRÍTICOS (BAJO STOCK) -->
    <h2>⚠️ Stock Crítico (Bajo Nivel)</h2>
    <table id="tablaStockCritico">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Categoría</th>
                <th>Cantidad Actual</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody id="cuerpoTablaStockCritico">
            <tr><td colspan="4" class="sin-datos">No hay productos con stock crítico</td></tr>
        </tbody>
    </table>
</div>

<script>
// 1. SEGURIDAD Y MENÚ
function updateMenuByRole(){
    const role = localStorage.getItem('rol');
    const loginLink = document.getElementById('loginLink');
    const logoutLink = document.getElementById('logoutLink');
    const bienvenida = document.getElementById('bienvenida');
    const inventarioLink = document.getElementById('inventarioLink');
    const stockLink = document.getElementById('stockLink');
    const productosLink = document.getElementById('productosLink');
    const informesLink = document.getElementById('informesLink');

    // Protección: solo admin puede acceder
    if(role !== 'admin'){
        alert('Acceso denegado. Solo administradores pueden acceder aquí.');
        window.location.href = 'base.html';
        return;
    }

    // Admin ve todas las opciones
    loginLink.style.display = 'none';
    logoutLink.style.display = 'inline';
    productosLink.style.display = 'inline';
    stockLink.style.display = 'inline';
    inventarioLink.style.display = 'inline';
    informesLink.style.display = 'inline';
    bienvenida.textContent = '¡Bienvenido admin!';
}

function cerrarSesion(){
    localStorage.removeItem('sesionActiva');
    localStorage.removeItem('mensajeLogin');
    localStorage.removeItem('rol');
    localStorage.removeItem('usuarioNombre');
    window.location.href = 'base.html';
}

// Marca el enlace activo en el menú según la página actual
function marcarPaginaActiva(){
    // Obtener el nombre del archivo actual
    const nombreArchivo = window.location.pathname.split('/').pop() || 'base.html';
    const mapa = {
        'base.html': 'inicio',
        'productos.html': 'productosLink',
        'stock.html': 'stockLink',
        'inventario.html': 'inventarioLink',
        'informes.html': 'informesLink',
        'Contacto.html': 'contactoLink',
        '': 'inicio' // En caso de ser raíz
    };
    
    const enlaceActivo = mapa[nombreArchivo];
    
    // Remover clase activa de todos los enlaces
    document.querySelectorAll('nav a').forEach(link => {
        link.classList.remove('activo');
    });
    
    // Agregar clase activa al enlace correspondiente
    if(enlaceActivo){
        const elemento = document.getElementById(enlaceActivo);
        if(elemento){
            elemento.classList.add('activo');
        } else if(enlaceActivo === 'inicio'){
            // Para el inicio, marcar el primer enlace o el que dice "Inicio"
            const inicioLink = Array.from(document.querySelectorAll('nav a')).find(a => 
                a.textContent.trim() === 'Inicio' || a.href.includes('base.html')
            );
            if(inicioLink) inicioLink.classList.add('activo');
        }
    }
}

document.addEventListener('DOMContentLoaded', function(){
    updateMenuByRole();
    marcarPaginaActiva();
    cargarInformacion();
});

// 2. CARGAR DATOS DE LOCALSTORAGE
let stock = JSON.parse(localStorage.getItem("stock")) || [];
let inventario = JSON.parse(localStorage.getItem("inventario")) || [];

// 3. GENERAR INFORME
function cargarInformacion(){
    // Limpiar tablas
    document.getElementById('cuerpoTablaStock').innerHTML = '';
    document.getElementById('cuerpoTablaSinUbicacion').innerHTML = '';
    document.getElementById('cuerpoTablaStockCritico').innerHTML = '';

    // Calcular estadísticas
    let totalProductos = stock.length;
    let totalUnidades = 0;
    let productosUbicados = 0;
    let sinUbicacion = 0;

    // Llenar tabla de stock
    if(stock.length === 0){
        document.getElementById('cuerpoTablaStock').innerHTML = '<tr><td colspan="5" class="sin-datos">No hay productos en stock</td></tr>';
    } else {
        stock.forEach((producto, i) => {
            totalUnidades += parseInt(producto.cantidad) || 0;
            
            const itemInventario = inventario.find(inv => inv.productoIndex === i);
            const ubicacion = itemInventario ? itemInventario.ubicacion : '-';
            const estado = itemInventario ? '✓' : '⚠️ Sin ubicar';
            
            if(itemInventario) productosUbicados++;
            else sinUbicacion++;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${producto.producto}</td>
                <td>${producto.categoria}</td>
                <td>${producto.cantidad}</td>
                <td>${ubicacion}</td>
                <td>${estado}</td>
            `;
            document.getElementById('cuerpoTablaStock').appendChild(tr);
        });
    }

    // Productos sin ubicación
    if(sinUbicacion > 0){
        stock.forEach((producto, i) => {
            const itemInventario = inventario.find(inv => inv.productoIndex === i);
            if(!itemInventario){
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${producto.producto}</td>
                    <td>${producto.categoria}</td>
                    <td>${producto.cantidad}</td>
                    <td><button onclick="window.location.href='inventario.html'">Ubicar</button></td>
                `;
                document.getElementById('cuerpoTablaSinUbicacion').appendChild(tr);
            }
        });
    }

    // Productos con bajo stock (menos de 5 unidades)
    let hayStockCritico = false;
    stock.forEach((producto) => {
        if(parseInt(producto.cantidad) < 5){
            hayStockCritico = true;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${producto.producto}</td>
                <td>${producto.categoria}</td>
                <td><strong style="color:var(--rojo);">${producto.cantidad}</strong></td>
                <td>⚠️ Stock bajo</td>
            `;
            document.getElementById('cuerpoTablaStockCritico').appendChild(tr);
        }
    });

    if(!hayStockCritico){
        document.getElementById('cuerpoTablaStockCritico').innerHTML = '<tr><td colspan="4" class="sin-datos">No hay productos con stock crítico</td></tr>';
    }

    // Actualizar estadísticas
    document.getElementById('totalProductos').textContent = totalProductos;
    document.getElementById('totalUnidades').textContent = totalUnidades;
    document.getElementById('productosUbicados').textContent = productosUbicados;
    document.getElementById('sinUbicacion').textContent = sinUbicacion;

    // Resumen
    const fechaActual = new Date().toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });

    const html = `
        <p><strong>Fecha del Informe:</strong> ${fechaActual}</p>
        <p><strong>Total de Productos:</strong> ${totalProductos} productos diferentes</p>
        <p><strong>Cantidad Total:</strong> ${totalUnidades} unidades en stock</p>
        <p><strong>Productos Ubicados:</strong> ${productosUbicados} (${totalProductos > 0 ? Math.round((productosUbicados/totalProductos)*100) : 0}%)</p>
        <p><strong>Productos sin Ubicación:</strong> ${sinUbicacion} producto(s)</p>
    `;

    document.getElementById('resumenInventario').innerHTML = html;
}

// 4. FUNCIONES DE EXPORTACIÓN A EXCEL
function descargarInformeExcel(){
    // Intentar usar XLSX si está disponible, si no usar CSV
    if(typeof XLSX !== 'undefined'){
        descargarConXLSX();
    } else {
        descargarCSV();
    }
}

// Exportar a CSV compatible con Excel
function descargarCSV(){
    let csv = '\uFEFF'; // BOM para UTF-8 en Excel
    csv += 'INFORME DE INVENTARIO Y STOCK\n';
    csv += 'FerreStock Bellon\n';
    csv += '\n';
    csv += 'Fecha de Generación: ' + new Date().toLocaleDateString('es-ES') + '\n';
    csv += '\n';
    
    // INVENTARIO
    csv += 'INVENTARIO GENERAL\n';
    csv += 'Producto,Categoría,Cantidad,Ubicación,Estado\n';
    
    stock.forEach((producto, i) => {
        const itemInventario = inventario.find(inv => inv.productoIndex === i);
        const ubicacion = itemInventario ? itemInventario.ubicacion : 'SIN ASIGNAR';
        const estado = itemInventario ? 'Ubicado' : 'Pendiente';
        
        csv += `"${producto.producto || ''}","${producto.categoria || ''}",${producto.cantidad || 0},"${ubicacion}","${estado}"\n`;
    });
    
    csv += '\n\n';
    
    // PRODUCTOS SIN UBICACIÓN
    const sinUbicacion = stock.filter((p, i) => !inventario.find(inv => inv.productoIndex === i));
    if(sinUbicacion.length > 0){
        csv += 'PRODUCTOS SIN UBICACIÓN\n';
        csv += 'Producto,Categoría,Cantidad,Prioridad\n';
        
        sinUbicacion.forEach((producto) => {
            csv += `"${producto.producto || ''}","${producto.categoria || ''}",${producto.cantidad || 0},"URGENTE"\n`;
        });
        
        csv += '\n\n';
    }
    
    // STOCK CRÍTICO
    const stockCritico = stock.filter(p => parseInt(p.cantidad) < 5);
    if(stockCritico.length > 0){
        csv += 'STOCK CRÍTICO\n';
        csv += 'Producto,Categoría,Cantidad,Alerta\n';
        
        stockCritico.forEach((producto) => {
            csv += `"${producto.producto || ''}","${producto.categoria || ''}",${producto.cantidad || 0},"REPONER"\n`;
        });
    }
    
    // Descargar como CSV
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `informe-ferrestock-${new Date().getTime()}.csv`;
    link.click();
}

// Exportar con XLSX (si está disponible)
function descargarConXLSX(){
    const ws_data = [];
    
    const fechaActual = new Date().toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });

    // ENCABEZADO
    ws_data.push(['INFORME DE INVENTARIO Y STOCK']);
    ws_data.push(['FerreStock Bellon']);
    ws_data.push(['']);
    ws_data.push(['Fecha de Generación: ' + fechaActual]);
    ws_data.push(['']);

    // RESUMEN EJECUTIVO
    ws_data.push(['RESUMEN EJECUTIVO']);
    const totalProductos = stock.length;
    const totalUnidades = stock.reduce((suma, p) => suma + (parseInt(p.cantidad) || 0), 0);
    const productosUbicados = inventario.filter((inv, i) => stock.findIndex(s => s === stock[s.indexOf(s)]) !== -1).length;
    
    ws_data.push(['Total de Productos', totalProductos]);
    ws_data.push(['Total de Unidades', totalUnidades]);
    ws_data.push(['']);

    // TABLA PRINCIPAL DE STOCK
    ws_data.push(['INVENTARIO GENERAL']);
    ws_data.push(['Producto', 'Categoría', 'Cantidad', 'Ubicación', 'Estado']);
    
    stock.forEach((producto, i) => {
        const itemInventario = inventario.find(inv => inv.productoIndex === i);
        const ubicacion = itemInventario ? itemInventario.ubicacion : 'SIN ASIGNAR';
        const estado = itemInventario ? 'Ubicado' : 'Pendiente';
        
        ws_data.push([
            producto.producto || '',
            producto.categoria || '',
            producto.cantidad || 0,
            ubicacion,
            estado
        ]);
    });

    ws_data.push(['']);

    // PRODUCTOS SIN UBICACIÓN
    const sinUbicacion = stock.filter((p, i) => !inventario.find(inv => inv.productoIndex === i));
    if(sinUbicacion.length > 0){
        ws_data.push(['PRODUCTOS SIN UBICACIÓN ASIGNADA']);
        ws_data.push(['Producto', 'Categoría', 'Cantidad', 'Prioridad']);
        
        sinUbicacion.forEach((producto) => {
            ws_data.push([
                producto.producto || '',
                producto.categoria || '',
                producto.cantidad || 0,
                'URGENTE'
            ]);
        });
        
        ws_data.push(['']);
    }

    // STOCK CRÍTICO
    const stockCritico = stock.filter(p => parseInt(p.cantidad) < 5);
    if(stockCritico.length > 0){
        ws_data.push(['STOCK CRÍTICO (MENOS DE 5 UNIDADES)']);
        ws_data.push(['Producto', 'Categoría', 'Cantidad Actual', 'Alerta']);
        
        stockCritico.forEach((producto) => {
            ws_data.push([
                producto.producto || '',
                producto.categoria || '',
                producto.cantidad || 0,
                'REPONER URGENTE'
            ]);
        });
        
        ws_data.push(['']);
    }

    // ESTADÍSTICAS POR CATEGORÍA
    const categorias = [...new Set(stock.map(p => p.categoria))];
    if(categorias.length > 0){
        ws_data.push(['ESTADÍSTICAS POR CATEGORÍA']);
        ws_data.push(['Categoría', 'Cantidad de Productos', 'Total de Unidades']);
        
        categorias.forEach((cat) => {
            const productosEnCat = stock.filter(p => p.categoria === cat);
            const unidadesEnCat = productosEnCat.reduce((suma, p) => suma + (parseInt(p.cantidad) || 0), 0);
            
            ws_data.push([
                cat || 'Sin Categoría',
                productosEnCat.length,
                unidadesEnCat
            ]);
        });
    }

    // Crear el libro de Excel
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);

    // Estilos y formato
    ws['!cols'] = [
        { wch: 25 },  // Producto
        { wch: 15 },  // Categoría
        { wch: 12 },  // Cantidad
        { wch: 20 },  // Ubicación
        { wch: 15 }   // Estado
    ];

    // Dar formato a celdas específicas
    const boldStyle = { font: { bold: true }, fill: { fgColor: { rgb: 'FFF2CC' } } };
    
    // Encabezado principal
    for(let i = 0; i < 2; i++){
        ws[XLSX.utils.encode_cell({r: i, c: 0})] = {v: ws_data[i][0], ...boldStyle};
    }

    XLSX.utils.book_append_sheet(wb, ws, "Informe Stock");
    
    // Descargar
    XLSX.writeFile(wb, `informe-ferrestock-${new Date().getTime()}.xlsx`);
}

function imprimirInforme(){
    window.print();
}
</script>

</body>
</html>
